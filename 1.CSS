<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoEntity Services Monitor - SAC VEDAS</title>
    <link rel="stylesheet" href="/geoentity_monitoring/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-animation">
        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
        <div class="circle circle-3"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="title-section">
                    <div class="logo">üõ∞Ô∏è</div>
                    <div>
                        <h1>GeoEntity Services Monitor</h1>
                        <p>Real-time monitoring of SAC VEDAS GeoEntity API endpoints</p>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="runCheck()">
                        <span class="btn-icon">üîÑ</span>
                        <span>Run Check Now</span>
                    </button>
                    <div class="auto-refresh">
                        <label class="switch">
                            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                            <span class="slider"></span>
                        </label>
                        <span class="refresh-label">Auto-refresh</span>
                        <select id="refreshInterval">
                            <option value="30">30s</option>
                            <option value="60" selected>1 min</option>
                            <option value="300">5 min</option>
                            <option value="600">10 min</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('basic')">
                <span>üìä</span> Basic Monitoring
            </button>
            <button class="tab-btn" onclick="switchTab('filter')">
                <span>üîç</span> Filter Checking
                <span class="badge-small" id="filterCheckBadge" style="display:none;">Running</span>
            </button>
        </div>

        <div id="basicTab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalEndpoints">-</div>
                        <div class="stat-label">Total Endpoints</div>
                    </div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-content">
                        <div class="stat-value" id="successCount">-</div>
                        <div class="stat-label">Success</div>
                    </div>
                </div>
                <div class="stat-card stat-error">
                    <div class="stat-icon">‚úó</div>
                    <div class="stat-content">
                        <div class="stat-value" id="failedCount">-</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <div class="stat-card stat-rate">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-content">
                        <div class="stat-value" id="successRate">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-content">
                        <div class="stat-value" id="avgResponse">-</div>
                        <div class="stat-label">Avg Response (ms)</div>
                    </div>
                </div>
            </div>

            <div class="main-status">
                <div class="section-header">
                    <h2>
                        <span class="status-indicator loading" id="mainStatus"></span>
                        Main API Endpoint Status
                    </h2>
                </div>
                <div id="mainApiStatus" class="api-status-content">
                    <p class="placeholder-text">Click "Run Check Now" to start monitoring</p>
                </div>
            </div>

            <div class="main-status">
                <div class="section-header">
                    <h2>GeoEntity Endpoints</h2>
                </div>
                <div class="filter-controls">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchBox" placeholder="Search by name, category, or project..." onkeyup="filterEndpoints()">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">
                            <span>All</span>
                        </button>
                        <button class="filter-btn" data-filter="success" onclick="setFilter('success')">
                            <span>‚úì Success</span>
                        </button>
                        <button class="filter-btn" data-filter="error" onclick="setFilter('error')">
                            <span>‚úó Failed</span>
                        </button>
                    </div>
                </div>
                <div class="endpoints-grid" id="endpointsGrid">
                    <p class="placeholder-text">Waiting for data...</p>
                </div>
            </div>
        </div>

        <div id="filterTab" class="tab-content">
            <div class="main-status">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2>üîç Detailed Filter Checking</h2>
                        <p style="color: #718096; font-size: 14px; margin-top: 8px;">
                            Check each geoentity with prefix parameter or bbox for specific sources
                        </p>
                        <p style="color: #718096; font-size: 13px; margin-top: 4px;" id="lastDailyCheck">
                            Last auto-check: Loading...
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="runAllFilterChecks()" id="runAllBtn">
                        <span>üöÄ</span> Run All Sources
                    </button>
                </div>

                <div id="filterCheckStatus" class="filter-status-box" style="display:none;">
                    <div class="progress-container">
                        <div class="progress-info">
                            <span id="filterStatusText">Initializing...</span>
                            <span id="filterProgress">0/0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="filterProgressBar"></div>
                        </div>
                        <div class="current-check" id="currentCheckInfo"></div>
                    </div>
                </div>

                <div id="filterSummaryGrid" class="stats-grid" style="margin-top: 20px;">
                    <p class="placeholder-text">Loading summary...</p>
                </div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            <span class="update-icon">üïê</span>
            <span id="lastUpdateText">Not checked yet</span>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Checking endpoints...</p>
        </div>
    </div>

    <div id="detailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Source Details</h3>
                <button class="btn-close" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <div id="paginationControls"></div>
                <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="/geoentity_monitoring/static/js/dashboard.js"></script>
</body>
</html>



let autoRefreshInterval = null;
let filterCheckInterval = null;
let currentFilter = 'all';
let allEndpoints = [];
let currentTab = 'basic';
let currentDetailPage = 1;
let currentDetailSourceId = null;

// Tab switching
function switchTab(tabName) {
    currentTab = tabName;
    
    var tabButtons = document.querySelectorAll('.tab-btn');
    for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
    }
    event.target.closest('.tab-btn').classList.add('active');
    
    document.getElementById('basicTab').classList.remove('active');
    document.getElementById('filterTab').classList.remove('active');
    
    if (tabName === 'basic') {
        document.getElementById('basicTab').classList.add('active');
    } else {
        document.getElementById('filterTab').classList.add('active');
        loadAllFilterResults();
    }
}

// Basic monitoring functions
async function runCheck() {
    document.getElementById('loadingOverlay').classList.add('active');
    
    try {
        const response = await fetch('/geoentity_monitoring/api/check');
        const data = await response.json();
        updateDashboard(data);
    } catch (error) {
        console.error('Error:', error);
        showError('Failed to fetch data. Please check your connection.');
    } finally {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
}

function showError(message) {
    const mainStatusDiv = document.getElementById('mainApiStatus');
    mainStatusDiv.innerHTML = '<div class="error-message">‚ùå ' + message + '</div>';
}

function updateDashboard(data) {
    const mainStatus = data.sources;
    const mainStatusDiv = document.getElementById('mainApiStatus');
    const mainIndicator = document.getElementById('mainStatus');
    
    if (mainStatus.status === 'success') {
        mainIndicator.className = 'status-indicator success';
        mainStatusDiv.innerHTML = 
            '<div class="endpoint-stats">' +
                '<span><strong>Status:</strong> ‚úì 200 OK</span>' +
                '<span><strong>Response Time:</strong> ' + mainStatus.response_time + 'ms</span>' +
                '<span><strong>Total Sources:</strong> ' + mainStatus.data.count + '</span>' +
                '<span><strong>Timestamp:</strong> ' + mainStatus.timestamp + '</span>' +
            '</div>';
    } else {
        mainIndicator.className = 'status-indicator error';
        mainStatusDiv.innerHTML = 
            '<div class="error-message">' +
                '‚ùå <strong>Status:</strong> Failed<br>' +
                '<strong>Error:</strong> ' + (mainStatus.error || 'Unknown error') +
            '</div>';
    }

    allEndpoints = data.geoentities || [];
    updateStats();
    displayEndpoints(allEndpoints);
    document.getElementById('lastUpdateText').textContent = 'Last updated: ' + data.last_check;
}

function updateStats() {
    const total = allEndpoints.length;
    const success = allEndpoints.filter(function(e) {
        return e.status === 'success';
    }).length;
    const failed = total - success;
    const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;
    const avgResponse = total > 0 
        ? (allEndpoints.reduce(function(sum, e) {
            return sum + e.response_time;
        }, 0) / total).toFixed(1)
        : 0;

    animateValue('totalEndpoints', parseInt(document.getElementById('totalEndpoints').textContent) || 0, total, 500);
    animateValue('successCount', parseInt(document.getElementById('successCount').textContent) || 0, success, 500);
    animateValue('failedCount', parseInt(document.getElementById('failedCount').textContent) || 0, failed, 500);
    
    document.getElementById('successRate').textContent = successRate + '%';
    document.getElementById('avgResponse').textContent = avgResponse;
}

function animateValue(id, start, end, duration) {
    const element = document.getElementById(id);
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(function() {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 16);
}

function displayEndpoints(endpoints) {
    const grid = document.getElementById('endpointsGrid');
    
    if (endpoints.length === 0) {
        grid.innerHTML = '<p class="placeholder-text">No endpoints match the current filter.</p>';
        return;
    }

    let html = '';
    for (var i = 0; i < endpoints.length; i++) {
        var endpoint = endpoints[i];
        var apiUrl = endpoint.url || '';
        
        html += '<div class="endpoint-card">' +
            '<div class="endpoint-header">' +
                '<span class="status-indicator ' + endpoint.status + '"></span>' +
                '<div class="endpoint-info">' +
                    '<div class="endpoint-name">' + endpoint.name + '</div>' +
                    '<div class="endpoint-meta">' +
                        '<span class="badge">' + endpoint.category + '</span>' +
                        '<span>üìÅ ' + endpoint.project + '</span>' +
                        '<span>üîë ID: ' + endpoint.id + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="endpoint-stats">' +
                '<span>‚ö° ' + endpoint.response_time + 'ms</span>' +
                '<span>üìä ' + endpoint.count + ' entities</span>' +
                '<span>üïê ' + endpoint.timestamp + '</span>' +
            '</div>' +
            '<div class="endpoint-actions">' +
                '<a href="' + apiUrl + '" target="_blank" class="btn-small">üîó Open API</a>' +
                '<button class="btn-small btn-primary-small" onclick="startFilterCheck(' + endpoint.id + ')">' +
                    'üîç Run Filter Check' +
                '</button>' +
            '</div>';
        
        if (endpoint.error) {
            html += '<div class="error-message">‚ùå <strong>Error:</strong> ' + endpoint.error + '</div>';
        }
        
        html += '</div>';
    }
    
    grid.innerHTML = html;
}

function filterEndpoints() {
    const searchTerm = document.getElementById('searchBox').value.toLowerCase();
    let filtered = allEndpoints.slice();

    if (currentFilter !== 'all') {
        filtered = filtered.filter(function(e) {
            return e.status === currentFilter;
        });
    }

    if (searchTerm) {
        filtered = filtered.filter(function(e) {
            return e.name.toLowerCase().indexOf(searchTerm) !== -1 ||
                   e.category.toLowerCase().indexOf(searchTerm) !== -1 ||
                   e.project.toLowerCase().indexOf(searchTerm) !== -1;
        });
    }

    displayEndpoints(filtered);
}

function setFilter(filter) {
    currentFilter = filter;
    var buttons = document.querySelectorAll('.filter-btn');
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('active');
        if (buttons[i].getAttribute('data-filter') === filter) {
            buttons[i].classList.add('active');
        }
    }
    filterEndpoints();
}

function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    
    if (checkbox.checked) {
        const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
        autoRefreshInterval = setInterval(runCheck, interval);
        runCheck();
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}

// Filter Check Functions
async function startFilterCheck(sourceId) {
    try {
        document.getElementById('loadingOverlay').classList.add('active');
        
        const response = await fetch('/geoentity_monitoring/api/filter-check/start/' + sourceId, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'started') {
            document.querySelectorAll('.tab-btn')[1].click();
            document.getElementById('filterCheckStatus').style.display = 'block';
            document.getElementById('filterCheckBadge').style.display = 'inline';
            startFilterCheckPolling(sourceId);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to start filter check');
    } finally {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
}

async function runAllFilterChecks() {
    if (confirm('This will check all sources with their geoentities. This may take 10-30 minutes. Continue?')) {
        try {
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('runAllBtn').disabled = true;
            
            const response = await fetch('/geoentity_monitoring/api/filter-check/start-all', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'started') {
                document.querySelectorAll('.tab-btn')[1].click();
                document.getElementById('filterCheckStatus').style.display = 'block';
                document.getElementById('filterCheckBadge').style.display = 'inline';
                startFilterCheckPolling(null);
            } else {
                alert('Error: ' + data.error);
                document.getElementById('runAllBtn').disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to start filter check');
            document.getElementById('runAllBtn').disabled = false;
        } finally {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    }
}

function startFilterCheckPolling(sourceId) {
    if (filterCheckInterval) {
        clearInterval(filterCheckInterval);
    }
    
    filterCheckInterval = setInterval(function() {
        updateFilterCheckStatus(sourceId);
    }, 1000);
}

async function updateFilterCheckStatus(sourceId) {
    try {
        const response = await fetch('/geoentity_monitoring/api/filter-check/status');
        const status = await response.json();
        
        if (status.last_daily_check) {
            var elem = document.getElementById('lastDailyCheck');
            if (elem) {
                elem.textContent = 'Last auto-check: ' + status.last_daily_check;
            }
        }
        
        if (status.running) {
            if (status.total_sources > 0) {
                var progressPercent = status.total_sources > 0 ? 
                    (status.completed_sources / status.total_sources * 100) : 0;
                
                document.getElementById('filterStatusText').textContent = 
                    'Checking all sources: ' + (status.current_source || 'Initializing...');
                document.getElementById('filterProgress').textContent = 
                    status.completed_sources + '/' + status.total_sources + ' sources';
                document.getElementById('filterProgressBar').style.width = progressPercent + '%';
                document.getElementById('currentCheckInfo').textContent = 
                    'Current entity: ' + (status.current_entity || 'Please wait...');
            } else {
                var progressPercent = status.total > 0 ? (status.progress / status.total * 100) : 0;
                
                document.getElementById('filterStatusText').textContent = 
                    'Checking: ' + (status.current_source || 'Initializing...');
                document.getElementById('filterProgress').textContent = 
                    status.progress + '/' + status.total;
                document.getElementById('filterProgressBar').style.width = progressPercent + '%';
                document.getElementById('currentCheckInfo').textContent = 
                    'Current: ' + (status.current_entity || 'Please wait...');
            }
        } else {
            clearInterval(filterCheckInterval);
            filterCheckInterval = null;
            
            document.getElementById('filterCheckStatus').style.display = 'none';
            document.getElementById('filterCheckBadge').style.display = 'none';
            var runBtn = document.getElementById('runAllBtn');
            if (runBtn) runBtn.disabled = false;
            
            loadAllFilterResults();
        }
    } catch (error) {
        console.error('Error polling status:', error);
    }
}

async function loadAllFilterResults() {
    try {
        var summaryGrid = document.getElementById('filterSummaryGrid');
        if (!summaryGrid) {
            console.error('filterSummaryGrid element not found');
            return;
        }
        
        summaryGrid.innerHTML = '<p class="placeholder-text">Loading summary...</p>';
        
        const response = await fetch('/geoentity_monitoring/api/filter-check/summary');
        const summary = await response.json();
        
        displayFilterSummary(summary);
    } catch (error) {
        console.error('Error loading summary:', error);
        var summaryGrid = document.getElementById('filterSummaryGrid');
        if (summaryGrid) {
            summaryGrid.innerHTML = '<p class="placeholder-text">Error loading results. Please try again.</p>';
        }
    }
}

function displayFilterSummary(summary) {
    const grid = document.getElementById('filterSummaryGrid');
    
    if (!grid) {
        console.error('filterSummaryGrid element not found');
        return;
    }
    
    if (Object.keys(summary).length === 0) {
        grid.innerHTML = '<p class="placeholder-text">No filter checks completed yet. Run a filter check from the Basic Monitoring tab.</p>';
        return;
    }
    
    let html = '';
    
    for (let key in summary) {
        const s = summary[key];
        const successRate = s.total_checks > 0 ? ((s.success_count / s.total_checks) * 100).toFixed(1) : 0;
        
        html += '<div class="source-summary-card" onclick="openDetailModal(' + s.source_id + ')">' +
            '<div class="source-summary-header">' +
                '<div class="source-summary-id">Source ' + s.source_id + '</div>' +
                '<div class="source-summary-type">' + (s.type || 'N/A') + '</div>' +
            '</div>' +
            '<div class="source-summary-stats">' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Total Checks</span>' +
                    '<span class="source-summary-stat-value">' + s.total_checks + '</span>' +
                '</div>' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Success Rate</span>' +
                    '<span class="source-summary-stat-value success">' + successRate + '%</span>' +
                '</div>' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Success</span>' +
                    '<span class="source-summary-stat-value success">' + s.success_count + '</span>' +
                '</div>' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Failed</span>' +
                    '<span class="source-summary-stat-value error">' + s.fail_count + '</span>' +
                '</div>' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Avg Time</span>' +
                    '<span class="source-summary-stat-value">' + s.avg_response_time + 'ms</span>' +
                '</div>' +
                '<div class="source-summary-stat">' +
                    '<span class="source-summary-stat-label">Status</span>' +
                    '<span class="source-summary-stat-value">' + (s.status || 'N/A') + '</span>' +
                '</div>' +
            '</div>' +
        '</div>';
    }
    
    grid.innerHTML = html;
}

async function openDetailModal(sourceId) {
    currentDetailSourceId = sourceId;
    currentDetailPage = 1;
    
    document.getElementById('detailModal').style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'Source ' + sourceId + ' - Loading...';
    document.getElementById('modalBody').innerHTML = '<p class="placeholder-text">Loading details...</p>';
    
    await loadDetailPage(sourceId, 1);
}

function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    currentDetailSourceId = null;
    currentDetailPage = 1;
}

async function loadDetailPage(sourceId, page) {
    try {
        const response = await fetch('/geoentity_monitoring/api/filter-check/result/' + sourceId + '/paginated?page=' + page + '&per_page=50');
        const data = await response.json();
        
        displayDetailPage(data);
    } catch (error) {
        console.error('Error loading details:', error);
        document.getElementById('modalBody').innerHTML = '<p class="placeholder-text">Error loading details.</p>';
    }
}

function displayDetailPage(data) {
    document.getElementById('modalTitle').textContent = 
        'Source ' + data.source_id + ' - Page ' + data.pagination.page + ' of ' + data.pagination.total_pages;
    
    let html = '<div class="filter-checks-grid">';
    
    for (let i = 0; i < data.checks.length; i++) {
        const check = data.checks[i];
        const statusClass = check.status === 'success' ? 'success' : 'error';
        const statusIcon = check.status === 'success' ? '‚úì' : '‚úó';
        
        html += '<div class="filter-check-item ' + statusClass + '">' +
            '<div class="filter-check-info">' +
                '<div class="filter-check-name">' + statusIcon + ' ';
        
        if (check.entity_name) {
            html += check.entity_name + ' (' + check.geoentity_id + ')';
        } else if (check.bbox) {
            html += 'BBox: ' + check.bbox;
        } else {
            html += check.geoentity_id || 'Check';
        }
        
        html += '</div>' +
            '<div class="filter-check-details">';
        
        if (check.parent_name) {
            html += 'Parent: ' + check.parent_name + ' | ';
        }
        
        html += '<a href="' + check.url + '" target="_blank" style="color: #667eea;">üîó Open</a>' +
            '</div>' +
            '</div>' +
            '<div class="filter-check-stats">' +
                '<span>' + check.response_time + 'ms</span>' +
                '<span>Count: ' + (check.count || 0) + '</span>' +
            '</div>' +
        '</div>';
    }
    
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    displayPagination(data.pagination);
}

function displayPagination(pagination) {
    let html = '';
    
    html += '<button class="pagination-btn" onclick="changePage(' + (pagination.page - 1) + ')" ' + 
        (pagination.has_prev ? '' : 'disabled') + '>‚Üê Previous</button>';
    
    html += '<span style="padding: 0 16px; font-weight: 600; color: #4a5568;">Page ' + 
        pagination.page + ' of ' + pagination.total_pages + '</span>';
    
    html += '<button class="pagination-btn" onclick="changePage(' + (pagination.page + 1) + ')" ' + 
        (pagination.has_next ? '' : 'disabled') + '>Next ‚Üí</button>';
    
    document.getElementById('paginationControls').innerHTML = html;
}

function changePage(page) {
    currentDetailPage = page;
    loadDetailPage(currentDetailSourceId, page);
}

// Initial check on page load
window.onload = function() {
    setTimeout(runCheck, 500);
};
